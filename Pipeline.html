<!DOCTYPE html><html lang="en" data-theme="light"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Production image Pipeline - Êú™ÂëΩÂêçÊñáÊ°£</title>
    
    
        <script src="asset/theme.js"></script>
    
<link rel="stylesheet" type="text/css" href="asset/plugins/theme-classic/844.index.css"><style data-rh="true">
:root {
    --ttw-primary-color: #21ba45;
}
</style><link rel="stylesheet" type="text/css" href="asset/plugins/highlight/81.index.css"><script charset="utf-8" data-webpack="TopWritePlugins = typeof TopWritePlugins === &quot;undefined&quot; ? {} : TopWritePlugins; TopWritePlugins['highlight']:chunk-81" src="asset/plugins/highlight/81.index.js"></script></head>
<body style="overflow: visible;">
<div id="root"><div class="navbar--a15beafa"><div class="inner--688a1365"><div class="items--bcfe621f"><a class="brand--50bec894" href="."><img class="logo--9f373004" src="logo.png" width="60" height="60" alt="logo"><strong class="title--ed7bbad8">Êú™ÂëΩÂêçÊñáÊ°£</strong></a></div><div class="items--bcfe621f"><div class="react-toggle"><div class="react-toggle-track"><div class="react-toggle-track-check">üåú</div><div class="react-toggle-track-x">üåû</div></div><div class="react-toggle-thumb"></div><input class="react-toggle-screenreader-only" type="checkbox"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><span class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></span><span class="DocSearch-Button-Key">K</span></span></button></div></div><div class="sidebar-backdrop--5a61f01d"></div><div class="sidebar--7ae7ff6a"><div class="sidebar-brand--045ce82b"><a class="brand--50bec894" href="."><img class="logo--9f373004" src="logo.png" width="60" height="60" alt="logo"><strong class="title--ed7bbad8">Êú™ÂëΩÂêçÊñáÊ°£</strong></a></div><div class="items--bcfe621f"></div></div></div><div class="page--f0f6908e"><div class="sidebar--fef9f737"><span class="button--8dedf7c3"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M64 384h384v-42.67H64zm0-106.67h384v-42.66H64zM64 128v42.67h384V128z"></path></svg></span><div class="catalog--ef2f939c"><div><ul><li class=""><div class="item--1a209e5a"><a href="IDE.html">IDE Integration</a></div></li><li class=""><div class="item--1a209e5a"><a href="Docker-compose.html">Docker-compose</a></div></li><li class=""><div class="item--1a209e5a"><a href="Schema.html">Images Schema</a></div></li><li class="open--938f5b49"><div class="item--1a209e5a active--c09d7805"><a href="Pipeline.html">Production image Pipeline</a></div></li></ul></div></div></div><div class="article--df0ce560"><div class="container--9c0374e9"><article><h1>Production image Pipeline</h1><h1><a aria-hidden="true" tabindex="-1" class="anchor" id="production-artifact-pipeline"></a>Production artifact pipeline</h1><p>This pipeline its just an example, for a more accurate approach see <a href="https://github.com/jorge07/ddd-playground">here</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="using-multi-stage-build"></a>Using Multi stage build</h3><p><strong>Dockerfile.build</strong></p><pre><code class="language-Dockerfile">FROM jorge07/alpine-php:7.1-dev-sf as builder

WORKDIR /api

ENV SYMFONY_ENV prod

COPY app /api/app
COPY bin /api/bin
COPY var /api/var

COPY composer.json /api
COPY composer.lock /api

RUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader

COPY src /api/src
COPY web /api/web

RUN composer run-script post-install-cmd \
    &amp;&amp; rm -rf /api/web/app_dev.php \
    &amp;&amp; rm -rf /api/web/config.php

FROM jorge07/alpine-php:7.1

ENV SYMFONY_ENV prod

COPY --from builder /api/app/app /app/app
COPY --from builder /api/app/bin /app/bin
COPY --from builder /api/app/var /app/var
COPY --from builder /api/app/web /app/web
COPY --from builder /api/app/src /app/src
COPY --from builder /api/app/vendor /app/vendor

RUN rm -rf /app/var/cache/* &amp;&amp; php /app/bin/console c:c
</code></pre><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="older-versions"></a>Older versions</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="build-environment"></a>Build environment</h3><p>I recommend build the artifact in the <code>jorge07/alpine-php:*-dev</code> image.</p><p><strong>Dockerfile.build</strong></p><pre><code class="language-Dockerfile">FROM jorge07/alpine-php:7-dev

ENV SYMFONY_ENV prod

COPY app /app/app
COPY parameters.yml /app/app/config/parameters.yml
COPY bin /app/bin
COPY var /app/var

COPY composer.json /app
COPY composer.lock /app

RUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader

COPY src /app/src
COPY web /app/web

RUN php /app/bin/console c:w
</code></pre><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="important"></a>Important</h4><p>To optimize build times using <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#/build-cache">Docker cache</a> I recommend add the src folders at the end of the <em>Dockerfile</em> after run <code>composer</code> and or <code>npm</code>.</p><pre><code class="language-Dockerfile">RUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader

COPY src /app/src
COPY web /app/web
</code></pre><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="build-artifact"></a>Build Artifact</h3><p><strong>Build image</strong></p><pre><code>docker build -t build-${RELEASE} -f Dockerfile.test .
</code></pre><p><strong>Up container</strong></p><pre><code>docker run -d --name build-container-${RELEASE} build-${RELEASE}
</code></pre><p><strong>Extract artifact</strong></p><pre><code>docker cp build-container-${RELEASE}:/app artifacts/${RELEASE}/
</code></pre><p><strong>Clean environment</strong></p><pre><code>docker kill build-container-${RELEASE}
docker rmi build-build-${RELEASE}
</code></pre><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="the-production-image"></a>The production image</h2><p>Extend Image. Add you PHP configuration and copy the entire artifact.</p><p><em>Dockerfile.prod</em></p><pre><code class="language-Dockerfile">FROM jorge07/alpine-php:7

COPY config/php/php.ini /etc/php7/conf.d/50-setting.ini
COPY config/php/php-fpm.conf /etc/php7/php-fpm.conf

ENV SYMFONY_ENV prod

COPY app/app /app/app
COPY fpm/parameters.yml /app/app/config/parameters.yml
COPY app/bin /app/bin
COPY app/var /app/var
COPY app/web /app/web
COPY app/src /app/src
COPY app/vendor /app/vendor

RUN php /app/bin/console c:w
</code></pre><p><strong>Build and Store final production image</strong></p><pre><code>docker build -t prod-${RELEASE} -f Dockerfile.prod artifacts/${RELEASE}/

docker login -u USER -p PASS

docker push prod-${RELEASE}
</code></pre><div class="pagination--369abd3a"><div class="item--1a209e5a"><a href="Schema.html"><div class="sub-label--5b72bdf2">Previous</div><div class="label--ce6da7fd">¬´ Images Schema</div></a></div><div class="item--1a209e5a"></div></div></article><aside><ul><li><p><a href="#production-artifact-pipeline">Production artifact pipeline</a></p><ul><li><ul><li><a href="#using-multi-stage-build">Using Multi stage build</a></li></ul></li><li><p><a href="#older-versions">Older versions</a></p><ul><li><p><a href="#build-environment">Build environment</a></p><ul><li><a href="#important">Important</a></li></ul></li><li><p><a href="#build-artifact">Build Artifact</a></p></li></ul></li><li><p><a href="#the-production-image">The production image</a></p></li></ul></li></ul></aside></div></div></div><footer class="footer--64c13cc4"><div class="container--1593c272"><div class="powerby--d1608b4c">Êú¨ÊñáÊ°£‰ΩøÁî® <a href="https://x.topthink.com" target="_blank">È°∂ÊÉ≥‰∫ë</a> ÊûÑÂª∫</div></div></footer></div>
<script type="application/payload+json">
{"book":{"id":"10"},"summary":[{"title":"Available documentation","articles":[{"title":"IDE Integration","ref":"IDE.md","path":"IDE.html","children":[]},{"title":"Docker-compose","ref":"Docker-compose.md","path":"Docker-compose.html","children":[]},{"title":"Images Schema","ref":"Schema.md","path":"Schema.html","children":[]},{"title":"Production image Pipeline","ref":"Pipeline.md","path":"Pipeline.html","children":[]}]}],"config":{"structure":{"summary":"README.md"},"root":"doc","theme":"classic","plugins":["highlight","tex"]},"file":{"path":"Pipeline.html","content":"# Production artifact pipeline\n\nThis pipeline its just an example, for a more accurate approach see [here](https:\/\/github.com\/jorge07\/ddd-playground)\n\n### Using Multi stage build\n\n**Dockerfile.build**\n\n```Dockerfile\nFROM jorge07\/alpine-php:7.1-dev-sf as builder\n\nWORKDIR \/api\n\nENV SYMFONY_ENV prod\n\nCOPY app \/api\/app\nCOPY bin \/api\/bin\nCOPY var \/api\/var\n\nCOPY composer.json \/api\nCOPY composer.lock \/api\n\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src \/api\/src\nCOPY web \/api\/web\n\nRUN composer run-script post-install-cmd \\\n    && rm -rf \/api\/web\/app_dev.php \\\n    && rm -rf \/api\/web\/config.php\n\nFROM jorge07\/alpine-php:7.1\n\nENV SYMFONY_ENV prod\n\nCOPY --from builder \/api\/app\/app \/app\/app\nCOPY --from builder \/api\/app\/bin \/app\/bin\nCOPY --from builder \/api\/app\/var \/app\/var\nCOPY --from builder \/api\/app\/web \/app\/web\nCOPY --from builder \/api\/app\/src \/app\/src\nCOPY --from builder \/api\/app\/vendor \/app\/vendor\n\nRUN rm -rf \/app\/var\/cache\/* && php \/app\/bin\/console c:c\n```\n\n## Older versions\n\n### Build environment\n\nI recommend build the artifact in the `jorge07\/alpine-php:*-dev` image.\n\n**Dockerfile.build**\n\n```Dockerfile\nFROM jorge07\/alpine-php:7-dev\n\nENV SYMFONY_ENV prod\n\nCOPY app \/app\/app\nCOPY parameters.yml \/app\/app\/config\/parameters.yml\nCOPY bin \/app\/bin\nCOPY var \/app\/var\n\nCOPY composer.json \/app\nCOPY composer.lock \/app\n\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src \/app\/src\nCOPY web \/app\/web\n\nRUN php \/app\/bin\/console c:w\n```\n\n#### Important\n\nTo optimize build times using [Docker cache](https:\/\/docs.docker.com\/engine\/userguide\/eng-image\/dockerfile_best-practices\/#\/build-cache) I recommend add the src folders at the end of the *Dockerfile* after run `composer` and or `npm`.\n\n```Dockerfile\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src \/app\/src\nCOPY web \/app\/web\n```\n\n### Build Artifact\n\n**Build image**\n\n```\ndocker build -t build-${RELEASE} -f Dockerfile.test .\n```\n\n**Up container**\n\n```\ndocker run -d --name build-container-${RELEASE} build-${RELEASE}\n```\n\n**Extract artifact**\n\n```\ndocker cp build-container-${RELEASE}:\/app artifacts\/${RELEASE}\/\n```\n\n**Clean environment**\n\n```\ndocker kill build-container-${RELEASE}\ndocker rmi build-build-${RELEASE}\n```\n\n## The production image\n\nExtend Image. Add you PHP configuration and copy the entire artifact.\n\n*Dockerfile.prod*\n\n```Dockerfile\nFROM jorge07\/alpine-php:7\n\nCOPY config\/php\/php.ini \/etc\/php7\/conf.d\/50-setting.ini\nCOPY config\/php\/php-fpm.conf \/etc\/php7\/php-fpm.conf\n\nENV SYMFONY_ENV prod\n\nCOPY app\/app \/app\/app\nCOPY fpm\/parameters.yml \/app\/app\/config\/parameters.yml\nCOPY app\/bin \/app\/bin\nCOPY app\/var \/app\/var\nCOPY app\/web \/app\/web\nCOPY app\/src \/app\/src\nCOPY app\/vendor \/app\/vendor\n\nRUN php \/app\/bin\/console c:w\n```\n\n**Build and Store final production image**\n\n```\ndocker build -t prod-${RELEASE} -f Dockerfile.prod artifacts\/${RELEASE}\/\n\ndocker login -u USER -p PASS\n\ndocker push prod-${RELEASE}\n```\n\n","meta":{"mtime":""}},"options":{}}
</script>

<script src="https://jsdelivr.topthink.com/npm/lodash@4.17/lodash.min.js"></script>

<script src="https://jsdelivr.topthink.com/npm/react@17/umd/react.production.min.js"></script>

<script src="https://jsdelivr.topthink.com/npm/react-dom@17/umd/react-dom.production.min.js"></script>

<script src="asset/index.js"></script>

<script src="asset/plugins/highlight/index.js"></script>

<script src="asset/plugins/tex/index.js"></script>

<script src="asset/plugins/theme-classic/index.js"></script>

<script type="text/javascript">
    TopWrite.bootstrap();
</script>


</body></html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Using Shortcuts and serverless to build a personal Apple Health API - Untitled</title>
    
    
    
    
</head>
<body>
<div id="root"></div>
<script type="application/payload+json">
{"book":{"id":"6rqjd5"},"summary":[{"title":"Featured","articles":[{"title":"IDE Integration","ref":"IDE.md","path":"IDE.html","children":[]},{"title":"Docker-compose","ref":"Docker-compose.md","path":"Docker-compose.html","children":[]},{"title":"Images Schema","ref":"Schema.md","path":"Schema.html","children":[]},{"title":"Using Shortcuts and serverless to build a personal Apple Health API","ref":"Pipeline.md","path":"Pipeline.html","children":[]}]}],"config":{"structure":{"summary":"README.md"},"plugins":["highlight"],"pluginsConfig":{"upyun":{"bucket":"topwrite-test","username":"webpack","password":"@encrypted:U2FsdGVkX1\/VM\/XVKWj3EwboAAjS850WhPC7G9GXzLHUeMf7IExBGubwdh9lNIO7AswI8dKr0IcVLFaliJOHSA=="}},"root":"doc"},"file":{"path":"Pipeline.html","content":"# Production artifact pipeline\n\nThis pipeline its just an example, for a more accurate approach see [here](https:\/\/github.com\/jorge07\/ddd-playground)\n\n### Using Multi stage build222\n\n**Dockerfile.build**\n\n\n# Production artifact pipeline\n\nThis pipeline its just an example, for a more accurate approach seeÂ [here](https:\/\/github.com\/jorge07\/ddd-playground)\n\n### []()Using Multi stage build\n\n**Dockerfile.build**\n\n```Dockerfile\nFROM jorge07\/alpine-php:7.1-dev-sf as builder\n\nWORKDIR \/api\n```\n\n\\\n\n\n\n```Dockerfile\nFROM jorge07\/alpine-php:7.1-dev-sf as builder\n\nWORKDIR \/api\n\nENV SYMFONY_ENV prod\n\nCOPY app \/api\/app\nCOPY bin \/api\/bin\nCOPY var \/api\/var\n\nCOPY composer.json \/api\nCOPY composer.lock \/api\n\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src \/api\/src\nCOPY web \/api\/web\n\nRUN composer run-script post-install-cmd \\\n    && rm -rf \/api\/web\/app_dev.php \\\n    && rm -rf \/api\/web\/config.php\n\nFROM jorge07\/alpine-php:7.1\n\nENV SYMFONY_ENV prod\n\nCOPY --from builder \/api\/app\/app \/app\/app\nCOPY --from builder \/api\/app\/bin \/app\/bin\nCOPY --from builder \/api\/app\/var \/app\/var\nCOPY --from builder \/api\/app\/web \/app\/web\nCOPY --from builder \/api\/app\/src \/app\/src\nCOPY --from builder \/api\/app\/vendor \/app\/vendor\n\nRUN rm -rf \/app\/var\/cache\/* && php \/app\/bin\/console c:c\n```\n\n## Older versions\n\n### Build environment\n\nI recommend build the artifact in the `jorge07\/alpine-php:*-dev` image.\n\n**Dockerfile.build**\n\n```Dockerfile\nFROM jorge07\/alpine-php:7-dev\n\nENV SYMFONY_ENV prod\n\nCOPY app \/app\/app\nCOPY parameters.yml \/app\/app\/config\/parameters.yml\nCOPY bin \/app\/bin\nCOPY var \/app\/var\n\nCOPY composer.json \/app\nCOPY composer.lock \/app\n\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src \/app\/src\nCOPY web \/app\/web\n\nRUN php \/app\/bin\/console c:w\n```\n\n#### Important\n\nTo optimize build times using [Docker cache](https:\/\/docs.docker.com\/engine\/userguide\/eng-image\/dockerfile_best-practices\/#\/build-cache) I recommend add the src folders at the end of the *Dockerfile* after run `composer` and or `npm`.\n\n```Dockerfile\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src \/app\/src\nCOPY web \/app\/web\n```\n\n### Build Artifact\n\n**Build image**\n\n```\ndocker build -t build-${RELEASE} -f Dockerfile.test .\n```\n\n**Up container**\n\n```\ndocker run -d --name build-container-${RELEASE} build-${RELEASE}\n```\n\n**Extract artifact**\n\n```\ndocker cp build-container-${RELEASE}:\/app artifacts\/${RELEASE}\/\n```\n\n**Clean environment**\n\n```\ndocker kill build-container-${RELEASE}\ndocker rmi build-build-${RELEASE}\n```\n\n## The production image\n\nExtend Image. Add you PHP configuration and copy the entire artifact.\n\n*Dockerfile.prod*\n\n```Dockerfile\nFROM jorge07\/alpine-php:7\n\nCOPY config\/php\/php.ini \/etc\/php7\/conf.d\/50-setting.ini\nCOPY config\/php\/php-fpm.conf \/etc\/php7\/php-fpm.conf\n\nENV SYMFONY_ENV prod\n\nCOPY app\/app \/app\/app\nCOPY fpm\/parameters.yml \/app\/app\/config\/parameters.yml\nCOPY app\/bin \/app\/bin\nCOPY app\/var \/app\/var\nCOPY app\/web \/app\/web\nCOPY app\/src \/app\/src\nCOPY app\/vendor \/app\/vendor\n\nRUN php \/app\/bin\/console c:w\n```\n\n**Build and Store final production image**\n\n```\ndocker build -t prod-${RELEASE} -f Dockerfile.prod artifacts\/${RELEASE}\/\n\ndocker login -u USER -p PASS\n\ndocker push prod-${RELEASE}\n```\n\n","meta":{"mtime":"2021-08-15T16:13:47+08:00"}},"options":{}}
</script>

    <script src="https://jsdelivr.topthink.com/npm/lodash@4.17/lodash.min.js"></script>

    <script src="https://jsdelivr.topthink.com/npm/react@17/umd/react.production.min.js"></script>

    <script src="https://jsdelivr.topthink.com/npm/react-dom@17/umd/react-dom.production.min.js"></script>

    <script src="asset/index.js"></script>

    <script src="asset/plugins/highlight/index.js"></script>

    <script src="asset/plugins/theme-default/index.js"></script>

<script type="text/javascript">
    TopWrite.bootstrap();
</script>
</body>
</html>

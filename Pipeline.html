<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Production image Pipeline - 未命名文档</title>
    
<link rel="stylesheet" type="text/css" href="asset/plugins/theme-default/829.index.css"></head>
<body>
<div id="root"><div><div class="Loading__loading___1m_fZ"><div class="Loading__bar___21yOt" style="background: rgb(33, 186, 69); width: 0%; display: none;"><div class="Loading__peg___3Y_28"></div></div></div><div class="Loading__spinner___11Pm4"><div class="Loading__icon___3OOyu" style="display: none; border-color: #21ba45;"></div></div></div><div class="body--4cb30f26 with-sidebar--64a35dd2"><div class="sidebar--92cdcd4d"><div class="header--fbbaa9f2"><a class="title--8b08af4e" href="."><img src="logo.png" width="30" height="30">未命名文档</a><div class="search--783540ff"><input type="search" placeholder="请输入搜索关键词……" value=""></div></div><div class="body--4cb30f26"><div class="summary--54538abb"><div class="part--2f00bd41"><div class="title--3df1ba16">Available documentation</div><ul><li class=""><div class="item--9cbf6482"><div class="whole--9f70f484"></div><span class="space--8603ccbf"></span><a class="text--59d9f9de" href="IDE.html">IDE Integration</a></div></li><li class=""><div class="item--9cbf6482"><div class="whole--9f70f484"></div><span class="space--8603ccbf"></span><a class="text--59d9f9de" href="Docker-compose.html">Docker-compose</a></div></li><li class=""><div class="item--9cbf6482"><div class="whole--9f70f484"></div><span class="space--8603ccbf"></span><a class="text--59d9f9de" href="Schema.html">Images Schema</a></div></li><li class=""><div class="item--9cbf6482 active--c30e4dc0"><div class="whole--9f70f484"></div><span class="space--8603ccbf"></span><a class="text--59d9f9de" href="Pipeline.html">Production image Pipeline</a></div></li></ul></div></div></div><div class="copyright--2aa57f2d">本文档使用 <a href="https://x.topthink.com" target="_blank">顶想云</a> 构建</div></div><div class="main--6aaec551"><div class="toolbar--af3e5b9e"><h1>Production image Pipeline</h1></div><div class="markdown-body"><h1>Production artifact pipeline</h1><p>This pipeline its just an example, for a more accurate approach see <a href="https://github.com/jorge07/ddd-playground" target="_blank">here</a></p><h3>Using Multi stage build</h3><p><strong>Dockerfile.build</strong></p><pre><code class="language-Dockerfile">FROM jorge07/alpine-php:7.1-dev-sf as builder

WORKDIR /api

ENV SYMFONY_ENV prod

COPY app /api/app
COPY bin /api/bin
COPY var /api/var

COPY composer.json /api
COPY composer.lock /api

RUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader

COPY src /api/src
COPY web /api/web

RUN composer run-script post-install-cmd \
    &amp;&amp; rm -rf /api/web/app_dev.php \
    &amp;&amp; rm -rf /api/web/config.php

FROM jorge07/alpine-php:7.1

ENV SYMFONY_ENV prod

COPY --from builder /api/app/app /app/app
COPY --from builder /api/app/bin /app/bin
COPY --from builder /api/app/var /app/var
COPY --from builder /api/app/web /app/web
COPY --from builder /api/app/src /app/src
COPY --from builder /api/app/vendor /app/vendor

RUN rm -rf /app/var/cache/* &amp;&amp; php /app/bin/console c:c
</code></pre><h2>Older versions</h2><h3>Build environment</h3><p>I recommend build the artifact in the <code>jorge07/alpine-php:*-dev</code> image.</p><p><strong>Dockerfile.build</strong></p><pre><code class="language-Dockerfile">FROM jorge07/alpine-php:7-dev

ENV SYMFONY_ENV prod

COPY app /app/app
COPY parameters.yml /app/app/config/parameters.yml
COPY bin /app/bin
COPY var /app/var

COPY composer.json /app
COPY composer.lock /app

RUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader

COPY src /app/src
COPY web /app/web

RUN php /app/bin/console c:w
</code></pre><h4>Important</h4><p>To optimize build times using <a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#/build-cache" target="_blank">Docker cache</a> I recommend add the src folders at the end of the <em>Dockerfile</em> after run <code>composer</code> and or <code>npm</code>.</p><pre><code class="language-Dockerfile">RUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader

COPY src /app/src
COPY web /app/web
</code></pre><h3>Build Artifact</h3><p><strong>Build image</strong></p><pre><code>docker build -t build-${RELEASE} -f Dockerfile.test .
</code></pre><p><strong>Up container</strong></p><pre><code>docker run -d --name build-container-${RELEASE} build-${RELEASE}
</code></pre><p><strong>Extract artifact</strong></p><pre><code>docker cp build-container-${RELEASE}:/app artifacts/${RELEASE}/
</code></pre><p><strong>Clean environment</strong></p><pre><code>docker kill build-container-${RELEASE}
docker rmi build-build-${RELEASE}
</code></pre><h2>The production image</h2><p>Extend Image. Add you PHP configuration and copy the entire artifact.</p><p><em>Dockerfile.prod</em></p><pre><code class="language-Dockerfile">FROM jorge07/alpine-php:7

COPY config/php/php.ini /etc/php7/conf.d/50-setting.ini
COPY config/php/php-fpm.conf /etc/php7/php-fpm.conf

ENV SYMFONY_ENV prod

COPY app/app /app/app
COPY fpm/parameters.yml /app/app/config/parameters.yml
COPY app/bin /app/bin
COPY app/var /app/var
COPY app/web /app/web
COPY app/src /app/src
COPY app/vendor /app/vendor

RUN php /app/bin/console c:w
</code></pre><p><strong>Build and Store final production image</strong></p><pre><code>docker build -t prod-${RELEASE} -f Dockerfile.prod artifacts/${RELEASE}/

docker login -u USER -p PASS

docker push prod-${RELEASE}
</code></pre></div><div class="navigation--93943883"><span class="prev--8f062b74">上一篇:<a href="Schema.html">Images Schema</a></span></div></div></div></div>
<script type="application/payload+json">
{"book":{"id":"3"},"summary":[{"title":"Available documentation","articles":[{"title":"IDE Integration","ref":"IDE.md","path":"IDE.html","children":[]},{"title":"Docker-compose","ref":"Docker-compose.md","path":"Docker-compose.html","children":[]},{"title":"Images Schema","ref":"Schema.md","path":"Schema.html","children":[]},{"title":"Production image Pipeline","ref":"Pipeline.md","path":"Pipeline.html","children":[]}]}],"config":{"structure":{"summary":"README.md"},"root":"doc"},"file":{"path":"Pipeline.html","content":"# Production artifact pipeline\n\nThis pipeline its just an example, for a more accurate approach see [here](https://github.com/jorge07/ddd-playground)\n\n### Using Multi stage build\n\n**Dockerfile.build**\n\n```Dockerfile\nFROM jorge07/alpine-php:7.1-dev-sf as builder\n\nWORKDIR /api\n\nENV SYMFONY_ENV prod\n\nCOPY app /api/app\nCOPY bin /api/bin\nCOPY var /api/var\n\nCOPY composer.json /api\nCOPY composer.lock /api\n\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src /api/src\nCOPY web /api/web\n\nRUN composer run-script post-install-cmd \\\n    && rm -rf /api/web/app_dev.php \\\n    && rm -rf /api/web/config.php\n\nFROM jorge07/alpine-php:7.1\n\nENV SYMFONY_ENV prod\n\nCOPY --from builder /api/app/app /app/app\nCOPY --from builder /api/app/bin /app/bin\nCOPY --from builder /api/app/var /app/var\nCOPY --from builder /api/app/web /app/web\nCOPY --from builder /api/app/src /app/src\nCOPY --from builder /api/app/vendor /app/vendor\n\nRUN rm -rf /app/var/cache/* && php /app/bin/console c:c\n```\n\n## Older versions\n\n### Build environment\n\nI recommend build the artifact in the `jorge07/alpine-php:*-dev` image.\n\n**Dockerfile.build**\n\n```Dockerfile\nFROM jorge07/alpine-php:7-dev\n\nENV SYMFONY_ENV prod\n\nCOPY app /app/app\nCOPY parameters.yml /app/app/config/parameters.yml\nCOPY bin /app/bin\nCOPY var /app/var\n\nCOPY composer.json /app\nCOPY composer.lock /app\n\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src /app/src\nCOPY web /app/web\n\nRUN php /app/bin/console c:w\n```\n\n#### Important\n\nTo optimize build times using [Docker cache](https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#/build-cache) I recommend add the src folders at the end of the *Dockerfile* after run `composer` and or `npm`.\n\n```Dockerfile\nRUN composer install --no-ansi --no-scripts --no-dev --no-interaction --no-progress --optimize-autoloader\n\nCOPY src /app/src\nCOPY web /app/web\n```\n\n### Build Artifact\n\n**Build image**\n\n    docker build -t build-${RELEASE} -f Dockerfile.test .\n\n**Up container**\n\n    docker run -d --name build-container-${RELEASE} build-${RELEASE}\n\n**Extract artifact**\n\n    docker cp build-container-${RELEASE}:/app artifacts/${RELEASE}/\n\n**Clean environment**\n\n    docker kill build-container-${RELEASE}\n    docker rmi build-build-${RELEASE}\n\n\n## The production image\n\nExtend Image. Add you PHP configuration and copy the entire artifact.\n\n*Dockerfile.prod*\n\n```Dockerfile\nFROM jorge07/alpine-php:7\n\nCOPY config/php/php.ini /etc/php7/conf.d/50-setting.ini\nCOPY config/php/php-fpm.conf /etc/php7/php-fpm.conf\n\nENV SYMFONY_ENV prod\n\nCOPY app/app /app/app\nCOPY fpm/parameters.yml /app/app/config/parameters.yml\nCOPY app/bin /app/bin\nCOPY app/var /app/var\nCOPY app/web /app/web\nCOPY app/src /app/src\nCOPY app/vendor /app/vendor\n\nRUN php /app/bin/console c:w\n```\n\n**Build and Store final production image**\n\n    docker build -t prod-${RELEASE} -f Dockerfile.prod artifacts/${RELEASE}/\n    \n    docker login -u USER -p PASS\n    \n    docker push prod-${RELEASE}\n"},"options":{}}
</script>

<script src="https://jsdelivr.topthink.com/npm/lodash@4.17/lodash.min.js"></script>

<script src="https://jsdelivr.topthink.com/npm/react@17/umd/react.production.min.js"></script>

<script src="https://jsdelivr.topthink.com/npm/react-dom@17/umd/react-dom.production.min.js"></script>

<script src="asset/index.js"></script>

<script src="asset/plugins/theme-default/index.js"></script>

<script type="text/javascript">
    TopWrite.bootstrap();
</script>


</body></html>